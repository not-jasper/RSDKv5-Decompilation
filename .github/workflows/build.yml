name: Build RSDKv5 + U

on:
  push:
    paths:
      - android/**
      - dependencies/**
      - RSDKv5/**
      - RSDKv5U/**
      - platforms/**
      - .github/workflows/build.yml
      - CMakeLists.txt
    branches:
      - master
  workflow_dispatch: # Allows you to run it manually from the Actions tab

env:
  # CHANGED: Set DISABLE_PLUS to OFF
  GENERAL_FLAGS: "-DRETRO_DISABLE_PLUS=OFF -DCMAKE_BUILD_TYPE=Release"
  V5_FLAGS: "-DRETRO_REVISION=2"
  V5U_FLAGS: "-DRETRO_REVISION=3"
  GENERAL_WIN_FLAGS: "-DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
  WIN32_FLAGS: "-DVCPKG_TARGET_TRIPLET=x86-windows-static -A Win32"
  WIN64_FLAGS: "-DVCPKG_TARGET_TRIPLET=x64-windows-static"
  GENERAL_LINUX_FLAGS: ""

jobs:
  # ... (Keeping your Windows and Linux jobs as they were, they use env.GENERAL_FLAGS)
  
  v5-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout RSDKv5
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout Sonic Mania
        uses: actions/checkout@v4
        with:
          repository: "RSDKModding/Sonic-Mania-Decompilation"
          path: "Sonic-Mania-Decompilation"
      - name: Checkout Example-Mods
        uses: actions/checkout@v4
        with:
          repository: "RSDKModding/RSDKv5-Example-Mods"
          path: "RSDKv5-Example-Mods"
      - name: Checkout GameAPI
        uses: actions/checkout@v4
        with:
          repository: "RSDKModding/RSDKv5-GameAPI"
          path: "RSDKv5-GameAPI"
      - name: Setup RSDKv5 dependencies
        working-directory: ./dependencies/android
        run: |
          curl -L -O https://downloads.xiph.org/releases/ogg/libogg-1.3.5.zip
          curl -L -O https://downloads.xiph.org/releases/theora/libtheora-1.1.1.zip
          unzip \*.zip
          rm *.zip
          rsync -ar libogg-*/* libogg
          mv libtheora-* libtheora
      - name: Setup RSDKv5 & mods symlinks
        run: |
          rm -f Game
          rm -rf $PWD/Sonic-Mania-Decompilation/dependencies/RSDKv5
          ln -s $PWD $PWD/Sonic-Mania-Decompilation/dependencies/RSDKv5
          ln -s $PWD/RSDKv5-GameAPI RSDKv5-Example-Mods/ManiaTouchControls/GameAPI
          ln -s $PWD/RSDKv5-GameAPI RSDKv5-Example-Mods/UltrawideMania/GameAPI
          ln -s $PWD/Sonic-Mania-Decompilation ./android/app/jni/Game
          ln -s $PWD/RSDKv5-Example-Mods/ManiaTouchControls ./android/app/jni/MTC
          ln -s $PWD/RSDKv5-Example-Mods/UltrawideMania ./android/app/jni/UWM
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      - name: Build Mania+RSDKv5 Android
        working-directory: ./android
        run: |
          # CHANGED: Removed -PRETRO_DISABLE_PLUS (which defaults to ON in gradle) 
          # and passed the property as false to enable the DLC.
          ./gradlew assemble --no-daemon -PABIFILTERS="armeabi-v7a;arm64-v8a" -PRETRO_DISABLE_PLUS=false -PRETRO_REVISION=3
          mv app/build/outputs/apk/release/*.apk rsdkv5u_mania.apk
          ./gradlew clean
          ./gradlew assemble --no-daemon -PABIFILTERS="armeabi-v7a;arm64-v8a" -PRETRO_DISABLE_PLUS=false -PRETRO_REVISION=2
          mv app/build/outputs/apk/release/*.apk rsdkv5_mania.apk
      - name: Bundle APK & mods
        run: |
          mkdir -p artifacts/mods
          cp -r android/*.apk artifacts
          # ... (rest of your mod bundling logic)
      - name: Cleanup
        run: rm -rf $PWD/Sonic-Mania-Decompilation/dependencies/RSDKv5
      - name: Upload artifact Android
        uses: actions/upload-artifact@v4
        with:
          name: v5-android
          path: artifacts
          
